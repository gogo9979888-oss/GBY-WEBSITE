<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆÙ‚Ø¹ Ø¨ÙŠØ¹ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</title>
    <style>
        :root {
            --primary-gold: #d4af37;
            --dark-gold: #b8941f;
            --accent-green: #22c55e;
            --light-bg: #f8faf5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--light-bg);
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-gold), var(--dark-gold));
            color: white;
            padding: 2rem 0;
            text-align: center;
        }
        
        .hero {
            padding: 3rem 0;
            text-align: center;
        }
        
        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 2rem auto;
            max-width: 800px;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #444;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-gold);
        }
        
        textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .payment-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .payment-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-option.active {
            border-color: var(--primary-gold);
            background: #fefce8;
        }
        
        .payment-details {
            display: none;
            background: #f8faf5;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, var(--primary-gold), var(--dark-gold));
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: transform 0.3s;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .hidden-admin {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--primary-gold);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .admin-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1001;
        }
        
        .admin-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 80%;
            background: white;
            border-radius: 15px;
            z-index: 1002;
            padding: 20px;
            overflow-y: auto;
        }
        
        .admin-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .export-btn, .delete-btn, .close-admin {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 8px;
        }
        
        .export-btn {
            background: var(--accent-green);
            color: white;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
        }
        
        .close-admin {
            background: #6b7280;
            color: white;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th, .data-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table th {
            background: #f8faf5;
            font-weight: 600;
        }
        
        .emails-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 70%;
            background: white;
            border-radius: 15px;
            z-index: 1003;
            padding: 20px;
            overflow-y: auto;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <h1>ğŸ’° Ù…ÙˆÙ‚Ø¹ Ø¨ÙŠØ¹ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</h1>
            <p>Ø¨ÙŠØ¹ Ø¥ÙŠÙ…ÙŠÙ„Ø§ØªÙƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ£Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø©</p>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <h2>Ø£Ø±Ø¨Ø­ Ù…Ù† Ø¥ÙŠÙ…ÙŠÙ„Ø§ØªÙƒ Ø§Ù„Ø¢Ù†!</h2>
            <p>Ù†Ø­Ù† Ù†Ø´ØªØ±ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø¨Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ© Ù…Ø¹ Ø¶Ù…Ø§Ù† Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©</p>
        </div>
    </section>

    <!-- Main Form -->
    <section class="container">
        <div class="form-container">
            <form id="sellForm">
                <div class="form-group">
                    <label for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
                    <input type="text" id="name" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„">
                </div>
                
                <div class="form-group">
                    <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ *</label>
                    <input type="email" id="email" required placeholder="example@domain.com">
                    <div class="error-message" id="emailError">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­</div>
                </div>
                
                <div class="form-group">
                    <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ *</label>
                    <input type="tel" id="phone" required placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ">
                </div>
                
                <div class="form-group">
                    <label for="emails">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø¥ÙŠÙ…ÙŠÙ„) *</label>
                    <textarea id="emails" required placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù‡Ù†Ø§ØŒ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ø¥ÙŠÙ…ÙŠÙ„&#10;Ù…Ø«Ø§Ù„:&#10;email1@example.com&#10;email2@example.com"></textarea>
                    <div id="emailCount" style="margin-top: 8px; color: #666; font-size: 14px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª: 0</div>
                </div>
                
                <div class="form-group">
                    <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£Ù…ÙˆØ§Ù„ *</label>
                    <div class="payment-options">
                        <div class="payment-option" data-method="orange">
                            ğŸŸ  Orange Cash
                        </div>
                        <div class="payment-option" data-method="binance">
                            ğŸŸ¡ Binance
                        </div>
                    </div>
                    
                    <div class="payment-details" id="orangeDetails">
                        <label for="orangeNumber">Ø±Ù‚Ù… Orange Cash *</label>
                        <input type="text" id="orangeNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Orange Cash">
                    </div>
                    
                    <div class="payment-details" id="binanceDetails">
                        <label for="binanceId">Ø±Ù‚Ù… Binance *</label>
                        <input type="text" id="binanceId" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Binance">
                    </div>
                </div>
                
                <button type="submit" class="submit-btn">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            </form>
        </div>
    </section>

    <!-- Features + Footer -->
    <section class="container">
        <div class="features" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(260px,1fr)); gap:16px; margin-bottom:28px;">
            <div class="feature" style="background:white; padding:18px; border-radius:12px; text-align:center;">
                <div style="font-size:30px">ğŸ’¸</div>
                <h3 style="color:var(--accent-green); margin-top:10px;">Ø£Ø³Ø¹Ø§Ø± Ù…Ù†Ø§ÙØ³Ø©</h3>
                <p>Ù†Ø¶Ù…Ù† Ø³Ø¹Ø±Ù‹Ø§ Ø¹Ø§Ø¯Ù„Ù‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª.</p>
            </div>
            <div class="feature" style="background:white; padding:18px; border-radius:12px; text-align:center;">
                <div style="font-size:30px">ğŸ”’</div>
                <h3 style="color:var(--accent-green); margin-top:10px;">Ø¢Ù…Ù† ÙˆÙ…ÙˆØ«ÙˆÙ‚</h3>
                <p>Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¢Ù…Ù†Ø© ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±ØªÙ‡Ø§ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….</p>
            </div>
            <div class="feature" style="background:white; padding:18px; border-radius:12px; text-align:center;">
                <div style="font-size:30px">âš¡</div>
                <h3 style="color:var(--accent-green); margin-top:10px;">Ø³Ø±ÙŠØ¹ Ø§Ù„ØªÙ†ÙÙŠØ°</h3>
                <p>Ù…Ø±Ø§Ø¬Ø¹Ø§Øª Ø³Ø±ÙŠØ¹Ø© ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ù…ÙˆØ§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø§ØªÙØ§Ù‚.</p>
            </div>
        </div>
    </section>

    <footer style="margin-top:30px; padding:24px 0; background: linear-gradient(90deg,var(--primary-gold),var(--dark-gold)); color:white; text-align:center;">
        <div class="container">
            <p>Â© 2025 Ù…ÙˆÙ‚Ø¹ Ø¨ÙŠØ¹ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
        </div>
    </footer>

    <!-- Hidden admin button + admin UI -->
    <button class="hidden-admin" id="hiddenAdminBtn" title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø®ÙÙŠØ©">ğŸ”’</button>

    <div class="admin-overlay" id="adminOverlay" style="display:none;"></div>

    <div class="admin-panel" id="adminPanel" style="display:none;">
        <div class="admin-header">
            <h2>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="close-admin" id="closeAdmin">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
                <button class="export-btn" id="refreshData">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>

        <div class="stats-cards" id="statsCards" style="margin-bottom:12px;">
            <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
        </div>

        <div style="margin-bottom:14px;">
            <button class="export-btn" id="exportAll">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="delete-btn" id="deleteAll">ğŸ—‘ï¸ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="export-btn" id="testData">ğŸ§ª Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
        </div>

        <table class="data-table" aria-live="polite">
            <thead>
                <tr>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</th>
                    <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="dataTableBody">
                <!-- Ø¨ÙŠØ§Ù†Ø§Øª -->
            </tbody>
        </table>

        <div id="noData" style="text-align:center; padding:30px; display:none;">
            <h3 style="color:#666; margin-bottom:8px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
            <p style="color:#999;">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙˆØ± Ø¥Ø±Ø³Ø§Ù„Ù‡Ù… Ù„Ù„Ù†Ù…Ø§Ø°Ø¬</p>
        </div>
    </div>

    <!-- Emails Modal -->
    <div class="emails-modal" id="emailsModal" style="display:none;">
        <div class="admin-header">
            <h3>ğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="close-admin" id="closeEmails">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>

        <div class="customer-info" id="customerInfo" style="background:#f7fff7; padding:12px; border-radius:8px; margin-bottom:12px;"></div>

        <h3>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª:</h3>
        <div class="emails-content" id="emailsContent" style="background:#f8faf5; padding:12px; border-radius:8px; white-space:pre-wrap; font-family:monospace;"></div>

        <div style="text-align:center; margin-top:12px;">
            <button class="export-btn" id="exportEmails">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</button>
            <button class="export-btn" id="copyEmailsBtn">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <!-- Supabase library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- SCRIPT -->
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
        const ADMIN_ACCESS_CODE = "19582006";

        // ğŸ”— eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwcnlzdXBpam94eWluZ3Nob3VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTA4NjUsImV4cCI6MjA3OTcyNjg2NX0.CGMRfI54Nq6I-8CgtlxUJ-KEjDPKg-r-Y9WO37yaBFE Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙ‚Ø·
        const SUPABASE_URL = "https://pprysupijoxyingshour.supabase.co";
        const SUPABASE_KEY = "PUT_YOUR_PUBLISHABLE_KEY_HERE"; // sb_publishable_... Ù…Ù† ØµÙØ­Ø© API

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentCustomerData = null;
        let currentCustomerEmails = "";

        // ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹ (Ø¹Ø±Ø¶ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©)
        document.querySelectorAll('.payment-option').forEach(option => {
            option.addEventListener('click', function(){
                document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
                this.classList.add('active');
                const method = this.getAttribute('data-method');
                if(method === 'orange'){
                    document.getElementById('orangeDetails').style.display = 'block';
                    document.getElementById('binanceDetails').style.display = 'none';
                } else {
                    document.getElementById('orangeDetails').style.display = 'none';
                    document.getElementById('binanceDetails').style.display = 'block';
                }
            });
        });

        // Ø¹Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        document.getElementById('emails').addEventListener('input', function() {
            const emailsText = this.value.trim();
            let count = 0;
            if(emailsText){
                const lines = emailsText.split(/\r?\n/).filter(l => l.trim() !== '');
                count = lines.length;
                if(count > 10000){
                    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø£ÙƒØ«Ø± Ù…Ù† 10,000 Ø¥ÙŠÙ…ÙŠÙ„');
                    this.value = lines.slice(0,10000).join('\n');
                    count = 10000;
                }
            }
            document.getElementById('emailCount').textContent = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª: ' + count;
        });

        // Ø¯Ø§Ù„Ø© ØªØ­Ù‚Ù‚ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        function validateEmail(email){
            if(!email) return false;
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/u;
            return re.test(email);
        }

        // ========= Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Supabase =========

        async function fetchCustomers(){
            const { data, error } = await supabase
                .from('GBY')
                .select('*')
                .order('id', { ascending: false });

            if(error){
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                return [];
            }
            return data || [];
        }

        async function createCustomer(formData, emailLinesCount){
            const { error } = await supabase
                .from('GBY')
                .insert([{
                    name: formData.name,
                    email: formData.email,
                    phone: formData.phone,
                    emails: formData.emails,
                    email_count: emailLinesCount,
                    payment_method: formData.paymentMethod,
                    payment_number: formData.paymentMethod === 'orange' ? formData.orangeNumber : formData.binanceId,
                    date_label: formData.date
                }]);

            if(error){
                console.error('Supabase insert error:', error);
                throw error;
            }
        }

        async function deleteCustomerById(id){
            const { error } = await supabase
                .from('GBY')
                .delete()
                .eq('id', id);
            if(error){
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„:', error);
                throw error;
            }
        }

        async function deleteAllCustomers(){
            const { error } = await supabase
                .from('GBY')
                .delete()
                .gt('id', 0); // ÙŠØ­Ø°Ù ÙƒÙ„ Ø§Ù„ØµÙÙˆÙ
            if(error){
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                throw error;
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±Ù…
        document.getElementById('sellForm').addEventListener('submit', async function(e){
            e.preventDefault();

            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const emailsVal = document.getElementById('emails').value.trim();
            const paymentMethod = document.querySelector('.payment-option.active')?.getAttribute('data-method') || null;
            const orangeNumber = document.getElementById('orangeNumber').value.trim();
            const binanceId = document.getElementById('binanceId').value.trim();

            // ØªØ­Ù‚Ù‚ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            if(!name || !email || !phone){
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ù‡Ø§ØªÙ');
                return;
            }

            // ØªØ­Ù‚Ù‚ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„
            const emailErrorDiv = document.getElementById('emailError');
            if(!validateEmail(email)){
                emailErrorDiv.style.display = 'block';
                alert('ğŸ›‘ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­. ØªØ£ÙƒØ¯ Ù…Ù† ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø«Ù„: name@example.com');
                return;
            } else {
                emailErrorDiv.style.display = 'none';
            }

            if(!paymentMethod){
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£Ù…ÙˆØ§Ù„');
                return;
            }
            if(paymentMethod === 'orange' && !orangeNumber){
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Orange Cash');
                return;
            }
            if(paymentMethod === 'binance' && !binanceId){
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Binance');
                return;
            }

            const emailLines = emailsVal ? emailsVal.split(/\r?\n/).filter(l => l.trim() !== '') : [];
            if(emailLines.length === 0){
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª (Ø³Ø·Ø± Ù„ÙƒÙ„ Ø¥ÙŠÙ…ÙŠÙ„)');
                return;
            }

            const formData = {
                name, email, phone, emails: emailsVal,
                paymentMethod, orangeNumber, binanceId,
                date: new Date().toLocaleString('ar-EG')
            };

            try {
                await createCustomer(formData, emailLines.length);
                alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø²Ø± ğŸ”’ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©)');
                this.reset();
                document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('active'));
                document.getElementById('orangeDetails').style.display = 'none';
                document.getElementById('binanceDetails').style.display = 'none';
                document.getElementById('emailCount').textContent = 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª: 0';

                // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ùˆ Ù…ÙØªÙˆØ­Ø©
                if(document.getElementById('adminPanel').style.display === 'block'){
                    loadCustomerData();
                    updateStats();
                }
            } catch(err){
                alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±ØŒ Ø­Ø§ÙˆÙ„ ØªØ§Ù†ÙŠ.');
            }
        });

        // Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…: Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø®ÙÙŠ
        let accessAttempts = 0;
        const maxAttempts = 3;

        document.getElementById('hiddenAdminBtn').addEventListener('click', function(){
            const code = prompt('ğŸ” Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„:');
            if(code === ADMIN_ACCESS_CODE){
                accessAttempts = 0;
                showAdminPanel();
            } else {
                accessAttempts++;
                alert('ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦. Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: ' + (maxAttempts - accessAttempts));
                if(accessAttempts >= maxAttempts){
                    alert('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                    setTimeout(() => location.reload(), 800);
                }
            }
        });

        function showAdminPanel(){
            document.getElementById('adminOverlay').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'block';
            loadCustomerData();
            updateStats();
        }

        document.getElementById('closeAdmin').addEventListener('click', function(){
            document.getElementById('adminOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
        });
        document.getElementById('adminOverlay').addEventListener('click', function(){
            document.getElementById('adminOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
        });

        // Ø§Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© (ØªØ±ÙˆØ­ Ù„Ù€ Supabase)
        document.getElementById('testData').addEventListener('click', async function(){
            const test = {
                name: "Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯",
                email: "test@example.com",
                phone: "01012345678",
                emails: "a@test.com\nb@test.com\nc@test.com",
                paymentMethod: "orange",
                orangeNumber: "01012345678",
                binanceId: "",
                date: new Date().toLocaleString('ar-EG')
            };
            try {
                await createCustomer(test, 3);
                alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
                loadCustomerData();
                updateStats();
            } catch(e){
                alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
            }
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        async function updateStats(){
            const data = await fetchCustomers();
            const statsCards = document.getElementById('statsCards');
            const totalCustomers = data.length;
            const totalEmails = data.reduce((s,c) => s + (c.email_count || 0), 0);
            const orangeCount = data.filter(c => c.payment_method === 'orange').length;
            const binanceCount = data.filter(c => c.payment_method === 'binance').length;

            statsCards.innerHTML = `
                <div class="stat-card" style="padding:12px; background:linear-gradient(90deg,#ecfccb,#bbf7d0); border-radius:10px; text-align:center;">
                    <h3 style="font-size:22px; margin:0">${totalCustomers}</h3>
                    <p style="margin:4px 0 0;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</p>
                </div>
                <div class="stat-card" style="padding:12px; background:linear-gradient(90deg,#ecfccb,#bbf7d0); border-radius:10px; text-align:center;">
                    <h3 style="font-size:22px; margin:0">${totalEmails}</h3>
                    <p style="margin:4px 0 0;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</p>
                </div>
                <div class="stat-card" style="padding:12px; background:linear-gradient(90deg,#ecfccb,#bbf7d0); border-radius:10px; text-align:center;">
                    <h3 style="font-size:22px; margin:0">${orangeCount}</h3>
                    <p style="margin:4px 0 0;">Ø¹Ù…Ù„Ø§Ø¡ Orange Cash</p>
                </div>
                <div class="stat-card" style="padding:12px; background:linear-gradient(90deg,#ecfccb,#bbf7d0); border-radius:10px; text-align:center;">
                    <h3 style="font-size:22px; margin:0">${binanceCount}</h3>
                    <p style="margin:4px 0 0;">Ø¹Ù…Ù„Ø§Ø¡ Binance</p>
                </div>
            `;
        }

        // ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ø¸Ù‡Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
        async function loadCustomerData(){
            const data = await fetchCustomers();
            const tbody = document.getElementById('dataTableBody');
            const noData = document.getElementById('noData');
            tbody.innerHTML = '';

            if(data.length === 0){
                noData.style.display = 'block';
                return;
            }
            noData.style.display = 'none';

            data.forEach(customer => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${escapeHtml(customer.date_label || '')}</td>
                    <td>${escapeHtml(customer.name || '')}</td>
                    <td>${escapeHtml(customer.email || '')}</td>
                    <td>${escapeHtml(customer.phone || '')}</td>
                    <td><strong>${customer.email_count || 0}</strong></td>
                    <td>${customer.payment_method === 'orange' ? 'ğŸŸ  Orange Cash' : 'ğŸŸ¡ Binance'}</td>
                    <td>${escapeHtml(customer.payment_number || '')}</td>
                    <td>
                        <button class="export-btn" onclick="showCustomerEmails(${customer.id})">ğŸ“§ Ø¹Ø±Ø¶</button>
                        <button class="delete-btn" onclick="deleteRecord(${customer.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function showCustomerEmails(customerId){
            const { data, error } = await supabase
                .from('GBY')
                .select('*')
                .eq('id', customerId)
                .single();

            if(error || !data){
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„');
                return;
            }

            const customer = data;
            currentCustomerData = customer;
            currentCustomerEmails = customer.emails || '';

            document.getElementById('customerInfo').innerHTML = `
                <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${escapeHtml(customer.name || '')}</p>
                <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${escapeHtml(customer.email || '')}</p>
                <p><strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${escapeHtml(customer.phone || '')}</p>
                <p><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong> ${customer.payment_method === 'orange' ? 'ğŸŸ  Orange Cash' : 'ğŸŸ¡ Binance'}</p>
                <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹:</strong> ${escapeHtml(customer.payment_number || '')}</p>
                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª:</strong> ${customer.email_count || 0}</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${escapeHtml(customer.date_label || '')}</p>
            `;
            document.getElementById('emailsContent').textContent = customer.emails || '';
            document.getElementById('emailsModal').style.display = 'block';
        }
        window.showCustomerEmails = showCustomerEmails;

        document.getElementById('closeEmails').addEventListener('click', function(){
            document.getElementById('emailsModal').style.display = 'none';
        });

        // Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
        document.getElementById('copyEmailsBtn').addEventListener('click', function(){
            if(!currentCustomerEmails) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ù„Ù„Ù†Ø³Ø®');
            navigator.clipboard.writeText(currentCustomerEmails)
                .then(() => alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©'))
                .catch(err => console.error(err));
        });

        // ØªØµØ¯ÙŠØ± Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
        document.getElementById('exportEmails').addEventListener('click', function(){
            if(!currentCustomerData) return;
            const c = currentCustomerData;
            const text = `Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„: ${c.name}\nØ§Ù„Ø¨Ø±ÙŠØ¯: ${c.email}\nØ§Ù„Ù‡Ø§ØªÙ: ${c.phone}\nØ·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${c.payment_method}\nØ±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹: ${c.payment_number}\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${c.date_label}\n\nØ§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª:\n${currentCustomerEmails}`;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `emails_${sanitizeFilename(c.name)}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('exportAll').addEventListener('click', async function(){
            const data = await fetchCustomers();
            if(data.length === 0){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
            let out = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ - Ù…ÙˆÙ‚Ø¹ Ø¨ÙŠØ¹ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª\n\n';
            data.forEach((c,i) => {
                out += `=== Ø¹Ù…ÙŠÙ„ ${i+1} ===\n`;
                out += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${c.date_label}\nØ§Ù„Ø§Ø³Ù…: ${c.name}\nØ§Ù„Ø¨Ø±ÙŠØ¯: ${c.email}\nØ§Ù„Ù‡Ø§ØªÙ: ${c.phone}\nØ¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª: ${c.email_count}\nØ·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹: ${c.payment_method}\nØ±Ù‚Ù… Ø§Ù„Ø¯ÙØ¹: ${c.payment_number}\nØ§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª:\n${c.emails}\n\n`;
            });
            const blob = new Blob([out], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `customers_data_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('ØªÙ… ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        });

        // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        document.getElementById('deleteAll').addEventListener('click', async function(){
            if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ')) return;
            try {
                await deleteAllCustomers();
                await loadCustomerData();
                await updateStats();
                alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            } catch(e){
                alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        });

        // Ø­Ø°Ù Ø³Ø¬Ù„ ÙˆØ§Ø­Ø¯
        async function deleteRecord(id){
            if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
            try {
                await deleteCustomerById(id);
                await loadCustomerData();
                await updateStats();
            } catch(e){
                alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„');
            }
        }
        window.deleteRecord = deleteRecord;

        // Ù…Ø³Ø§Ø¹Ø¯Ø© ØµØºÙŠØ±Ø© Ù„Ù…Ù†Ø¹ XSS Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ø±Ø¶
        function escapeHtml(text){
            if(!text) return '';
            return text.replace(/[&<>"'`=\\/]/g, function(s){
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[s]);
            });
        }

        function sanitizeFilename(name){
            return (name || 'user').replace(/[^a-z0-9_\-\u0600-\u06FF ]/gi, '').replace(/\s+/g,'_');
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø¨Ø³ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.addEventListener('DOMContentLoaded', function(){
            const btn = document.querySelector('#sellForm .submit-btn');
            if(btn) btn.setAttribute('type','submit');
            updateStats();
        });

        // Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
        document.getElementById('refreshData').addEventListener('click', function(){
            loadCustomerData();
            updateStats();
            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        });
    </script>
</body>
</html>
