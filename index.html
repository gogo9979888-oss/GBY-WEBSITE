<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù…ÙˆÙ‚Ø¹ Ø¨ÙŠØ¹ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {font-family:Tahoma;background:#f8faf5;margin:0}
    header {background:linear-gradient(90deg,#d4af37,#b8941f);padding:20px;color:#fff;text-align:center}
    .container {max-width:800px;margin:auto;padding:15px}
    .box {background:#fff;padding:20px;border-radius:10px;box-shadow:0 0 10px #00000015}
    input,textarea {width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;box-sizing:border-box}
    button {padding:12px;background:#22c55e;color:#fff;border:none;border-radius:6px;width:100%;cursor:pointer}
    button:hover{opacity:0.8}
    .payments{display:flex;gap:10px;margin:15px 0}
    .pay{flex:1;border:2px solid #ddd;padding:10px;text-align:center;border-radius:6px;cursor:pointer}
    .pay.active{border-color:#d4af37;background:#fff9db}
    .admin-btn{position:fixed;bottom:15px;left:15px;width:45px;height:45px;border-radius:50%;background:#d4af37;color:white;font-size:18px;border:none;cursor:pointer}
    .admin{display:none;position:fixed;top:5%;left:5%;width:90%;height:90%;background:#fff;overflow:auto;padding:20px;border-radius:12px;box-shadow:0 0 20px rgba(0,0,0,0.3);z-index:1000}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{border-bottom:1px solid #ddd;padding:12px;text-align:right}
    th{background:#f5f5f5}
    .count{color:#d4af37;font-weight:bold;margin:10px 0}
    .close-admin{position:absolute;top:10px;left:10px;background:#ff4444;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer}
  </style>
</head>

<body>

<header>
  <h2>ğŸ’° Ù…ÙˆÙ‚Ø¹ Ø¨ÙŠØ¹ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</h2>
</header>

<div class="container">
  <div class="box">
    <form id="sellForm">
      <input type="text" id="name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
      <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
      <input type="tel" id="phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>

      <textarea id="emails" placeholder="Ø³Ø·Ø± Ù„ÙƒÙ„ Ø¥ÙŠÙ…ÙŠÙ„" rows="5"></textarea>
      <div id="count" class="count">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª: 0</div>

      <div class="payments">
        <div class="pay" data-method="orange">ğŸŸ  Orange Cash</div>
        <div class="pay" data-method="binance">ğŸŸ¡ Binance</div>
      </div>

      <input type="text" id="orange" placeholder="Ø±Ù‚Ù… Orange Cash" style="display:none">
      <input type="text" id="binance" placeholder="Binance ID" style="display:none">

      <button type="submit">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    </form>
  </div>
</div>

<button class="admin-btn" id="adminBtn">ğŸ”’</button>

<div class="admin" id="adminPanel">
  <button class="close-admin" onclick="closeAdmin()">âœ•</button>
  <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
  <div style="margin:15px 0;">
    <button onclick="load()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <button onclick="deleteAll()" style="background:#ff4444;margin-right:10px;">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th>
        <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª</th>
        <th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø­Ø°Ù</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>

const ADMIN_CODE = "19582006";

// âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
const SUPABASE_URL = "https://pprysupijoxyingshour.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwcnlzdXBpam94eWluZ3Nob3VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTA4NjUsImV4cCI6MjA3OTcyNjg2NX0.CGMRfI54Nq6I-8CgtlxUJ-KEjDPKg-r-Y9WO37yaBFE";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let payMethod = null;

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ±
const nameEl = document.getElementById("name");
const emailEl = document.getElementById("email");
const phoneEl = document.getElementById("phone");
const emailsEl = document.getElementById("emails");
const orangeInput = document.getElementById("orange");
const binanceInput = document.getElementById("binance");
const adminBtn = document.getElementById("adminBtn");
const adminPanel = document.getElementById("adminPanel");
const tableBody = document.getElementById("tableBody");
const countDisplay = document.getElementById("count");

// Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
document.querySelectorAll('.pay').forEach(button => {
  button.onclick = () => {
    document.querySelectorAll('.pay').forEach(x => x.classList.remove('active'));
    button.classList.add('active');
    payMethod = button.getAttribute('data-method');
    
    // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹
    orangeInput.style.display = payMethod === "orange" ? "block" : "none";
    binanceInput.style.display = payMethod === "binance" ? "block" : "none";
    
    // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø­Ù‚ÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
    if (payMethod !== "orange") orangeInput.value = "";
    if (payMethod !== "binance") binanceInput.value = "";
  }
});

// Ø¹Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª
emailsEl.oninput = function(){
  let emailList = this.value.trim().split("\n").filter(x => x.trim());
  let validEmails = emailList.filter(email => 
    email.includes('@') && email.includes('.')
  );
  let n = validEmails.length;
  countDisplay.innerText = "Ø¹Ø¯Ø¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª: " + n;
  
  // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø¹Ø¯Ø¯ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµØ­Ø©
  if (n === 0) {
    countDisplay.style.color = '#ff4444';
  } else if (n < emailList.length) {
    countDisplay.style.color = '#ff8800';
  } else {
    countDisplay.style.color = '#d4af37';
  }
}

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
document.getElementById("sellForm").onsubmit = async (e) => {
  e.preventDefault();

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  let name = nameEl.value.trim();
  let email = emailEl.value.trim();
  let phone = phoneEl.value.trim();
  let emails = emailsEl.value.trim();
  let emailList = emails.split("\n").filter(x => x.trim());
  let count = emailList.length;

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  if (!name || !email || !phone) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");
    return;
  }

  if (count === 0) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª");
    return;
  }

  if (!payMethod) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹");
    return;
  }

  let paynum = payMethod === "orange" ? orangeInput.value.trim() : binanceInput.value.trim();

  if (!paynum) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹");
    return;
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø¨Ø¹Ø¶ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
  let validEmails = emailList.filter(email => 
    email.includes('@') && email.includes('.')
  );

  if (validEmails.length === 0) {
    alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¥ÙŠÙ…ÙŠÙ„Ø§Øª ØµØ­ÙŠØ­Ø©");
    return;
  }

  try {
    const { data, error } = await supabase.from("GBB").insert([{
      name: name,
      email: email,
      phone: phone,
      emails: emails,
      email_count: count,
      payment_method: payMethod,
      payment_number: paynum,
      date_label: new Date().toLocaleString("ar-EG")
    }]);

    if (error) {
      console.error("Supabase error:", error);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
      return;
    }

    alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
    location.reload();
  } catch (error) {
    console.error("Error:", error);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹");
  }
}

// Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
adminBtn.onclick = () => {
  let code = prompt("ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„:");
  if (code === ADMIN_CODE) {
    adminPanel.style.display = "block";
    load();
  } else if (code !== null) {
    alert("âŒ ÙƒÙˆØ¯ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­");
  }
}

function closeAdmin() {
  adminPanel.style.display = "none";
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function load() {
  try {
    let { data, error } = await supabase.from("GBB").select("*").order("id", { ascending: false });
    
    if (error) {
      console.error("Error loading data:", error);
      alert("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      return;
    }

    let tableHTML = "";
    if (data && data.length > 0) {
      data.forEach(record => {
        tableHTML += `
          <tr>
            <td>${escapeHtml(record.name)}</td>
            <td>${escapeHtml(record.phone)}</td>
            <td>${record.email_count}</td>
            <td>${escapeHtml(record.payment_method)}</td>
            <td>${escapeHtml(record.date_label)}</td>
            <td><button onclick="del(${record.id})" style="background:#ff4444;padding:5px 10px;">ğŸ—‘</button></td>
          </tr>
        `;
      });
    } else {
      tableHTML = `<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
    }
    
    tableBody.innerHTML = tableHTML;
  } catch (error) {
    console.error("Error:", error);
    alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
  }
}

// Ø­Ø°Ù Ø³Ø¬Ù„
async function del(id) {
  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
    try {
      const { error } = await supabase.from("GBB").delete().eq("id", id);
      
      if (error) {
        console.error("Error deleting:", error);
        alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù");
        return;
      }
      
      load();
    } catch (error) {
      console.error("Error:", error);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù");
    }
  }
}

// Ø­Ø°Ù Ø§Ù„ÙƒÙ„
async function deleteAll() {
  if (confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!")) {
    try {
      const { error } = await supabase.from("GBB").delete().gt("id", 0);
      
      if (error) {
        console.error("Error deleting all:", error);
        alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        return;
      }
      
      alert("âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
      load();
    } catch (error) {
      console.error("Error:", error);
      alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    }
  }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø£Ù…Ø§Ù† - Ù…Ù†Ø¹ Ø­Ù‚Ù† HTML
function escapeHtml(unsafe) {
  if (unsafe === null || unsafe === undefined) return '';
  return unsafe
    .toString()
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Ø¥ØºÙ„Ø§Ù‚ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø²Ø± ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeAdmin();
  }
});

</script>

</body>
</html>
